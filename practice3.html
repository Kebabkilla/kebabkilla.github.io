<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bass Scale Exercise - Major & Minor</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
            padding: 20px;
            margin: 0;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: #00d4ff;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
            margin-bottom: 10px;
        }
        
        .subtitle {
            text-align: center;
            color: #aaa;
            margin-bottom: 20px;
        }
        
        .controls {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .control-group label {
            font-size: 14px;
            color: #aaa;
        }
        
        input[type="range"] {
            width: 150px;
        }
        
        select {
            padding: 8px 12px;
            border-radius: 5px;
            border: none;
            background: #333;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
        }
        
        button {
            background: #00d4ff;
            color: #1a1a2e;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        button:hover {
            background: #00b8e6;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.4);
        }
        
        button:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
        }
        
        .scale-type-selector {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .scale-type-btn {
            padding: 10px 25px;
            font-size: 14px;
            background: rgba(255,255,255,0.1);
            border: 2px solid transparent;
        }
        
        .scale-type-btn.active {
            background: #00d4ff;
            border-color: #00d4ff;
        }
        
        .scale-type-btn.major.active {
            background: #ff6b6b;
            border-color: #ff6b6b;
        }
        
        .scale-type-btn.minor.active {
            background: #6bcb77;
            border-color: #6bcb77;
        }
        
        .positions-container {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .positions-title {
            text-align: center;
            margin-bottom: 10px;
            color: #aaa;
            font-size: 14px;
        }
        
        .positions-grid {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .position-btn {
            padding: 10px 20px;
            font-size: 14px;
            background: rgba(255,255,255,0.1);
            border: 2px solid transparent;
            min-width: 100px;
        }
        
        .position-btn.active {
            border-color: currentColor;
        }
        
        .position-btn.pos1 { color: #ff6b6b; }
        .position-btn.pos1.active { background: rgba(255, 107, 107, 0.3); }
        
        .position-btn.pos2 { color: #ffd93d; }
        .position-btn.pos2.active { background: rgba(255, 217, 61, 0.3); }
        
        .position-btn.pos3 { color: #6bcb77; }
        .position-btn.pos3.active { background: rgba(107, 203, 119, 0.3); }
        
        .position-btn.pos4 { color: #9b59b6; }
        .position-btn.pos4.active { background: rgba(155, 89, 182, 0.3); }
        
        .position-btn.pos5 { color: #00d4ff; }
        .position-btn.pos5.active { background: rgba(0, 212, 255, 0.3); }
        
        .position-btn.all-positions {
            color: #fff;
            background: rgba(255,255,255,0.1);
        }
        
        .position-btn.all-positions.active {
            background: rgba(255,255,255,0.3);
            border-color: #fff;
        }
        
        .current-info {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .key-display {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .scale-display {
            font-size: 18px;
            color: #aaa;
        }
        
        .fretboard {
            background: linear-gradient(180deg, #3d2b1f 0%, #2a1f15 100%);
            border-radius: 10px;
            padding: 30px;
            overflow-x: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            position: relative;
        }
        
        .fret-numbers {
            display: flex;
            margin-left: 40px;
            margin-bottom: 10px;
        }
        
        .fret-num {
            width: 45px;
            text-align: center;
            color: #888;
            font-size: 12px;
        }
        
        .string {
            display: flex;
            align-items: center;
            margin: 12px 0;
            position: relative;
        }
        
        .string-label {
            width: 40px;
            font-weight: bold;
            color: #00d4ff;
            font-size: 18px;
        }
        
        .string-line {
            flex: 1;
            height: 4px;
            background: linear-gradient(90deg, #b8860b 0%, #daa520 50%, #b8860b 100%);
            position: relative;
            margin: 0 10px;
            border-radius: 2px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        
        .string[data-string="0"] .string-line { height: 2px; }
        .string[data-string="1"] .string-line { height: 3px; }
        .string[data-string="2"] .string-line { height: 4px; }
        .string[data-string="3"] .string-line { height: 5px; }
        
        .fret {
            position: absolute;
            width: 45px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .fret-marker {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: #555;
            transition: all 0.15s;
            position: relative;
        }
        
        .fret.active .fret-marker {
            transform: scale(1.4);
            box-shadow: 0 0 30px currentColor;
            z-index: 10;
            border-color: #fff !important;
        }
        
        .fret.in-scale .fret-marker {
            color: #fff;
            font-weight: bold;
            border-width: 2px;
        }
        
        .fret.root .fret-marker {
            border-width: 3px;
            font-size: 14px;
        }
        
        /* Multi-color for overlapping positions */
        .fret-marker.multi-color {
            background: conic-gradient(var(--colors));
        }
        
        .exercise-info {
            text-align: center;
            margin-top: 20px;
            font-size: 18px;
            color: #00d4ff;
            min-height: 30px;
        }
        
        .tempo-display {
            font-size: 24px;
            font-weight: bold;
            color: #00ff88;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #aaa;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }
        
        .nav-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
        
        .nav-btn {
            padding: 8px 20px;
            font-size: 14px;
            background: rgba(255,255,255,0.1);
        }
        
        .nav-btn:hover {
            background: rgba(255,255,255,0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé∏ Bass Scale Exercise</h1>
        <p class="subtitle">Major & Minor Scales in All Keys with 5 Positions</p>
        
        <div class="controls">
            <div class="control-group">
                <label>Key</label>
                <select id="keySelect">
                    <option value="0">C</option>
                    <option value="1">C# / Db</option>
                    <option value="2">D</option>
                    <option value="3">D# / Eb</option>
                    <option value="4">E</option>
                    <option value="5">F</option>
                    <option value="6">F# / Gb</option>
                    <option value="7">G</option>
                    <option value="8">G# / Ab</option>
                    <option value="9">A</option>
                    <option value="10">A# / Bb</option>
                    <option value="11">B</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Tempo: <span class="tempo-display" id="tempoDisplay">70</span> BPM</label>
                <input type="range" id="tempoSlider" min="40" max="180" value="70" step="5">
            </div>

            <div class="control-group">
                <label>Volume: <span id="volumeDisplay">70</span>%</label>
                <input type="range" id="volumeSlider" min="0" max="100" value="70" step="5">
            </div>
            
            <button id="playBtn">‚ñ∂ Play</button>
            <button id="stopBtn" disabled>‚èπ Stop</button>
        </div>
        
        <div class="scale-type-selector">
            <button class="scale-type-btn major active" data-type="major">Major</button>
            <button class="scale-type-btn minor" data-type="minor">Natural Minor</button>
        </div>
        
        <div class="positions-container">
            <div class="positions-title">Scale Positions (click to toggle)</div>
            <div class="positions-grid">
                <button class="position-btn all-positions active" id="allPositionsBtn">All</button>
                <button class="position-btn pos1 active" data-position="1">Position 1</button>
                <button class="position-btn pos2 active" data-position="2">Position 2</button>
                <button class="position-btn pos3 active" data-position="3">Position 3</button>
                <button class="position-btn pos4 active" data-position="4">Position 4</button>
                <button class="position-btn pos5 active" data-position="5">Position 5</button>
            </div>
        </div>
        
        <div class="current-info">
            <div class="key-display" id="keyDisplay">C Major</div>
            <div class="scale-display" id="scaleDisplay">C - D - E - F - G - A - B</div>
        </div>
        
        <div class="fretboard" id="fretboard">
            <div class="fret-numbers" id="fretNumbers"></div>
            <div class="string" data-string="0">
                <div class="string-label">G</div>
                <div class="string-line" data-string="0"></div>
            </div>
            <div class="string" data-string="1">
                <div class="string-label">D</div>
                <div class="string-line" data-string="1"></div>
            </div>
            <div class="string" data-string="2">
                <div class="string-label">A</div>
                <div class="string-line" data-string="2"></div>
            </div>
            <div class="string" data-string="3">
                <div class="string-label">E</div>
                <div class="string-line" data-string="3"></div>
            </div>
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #ff6b6b;"></div>
                <span>Position 1</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ffd93d;"></div>
                <span>Position 2</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #6bcb77;"></div>
                <span>Position 3</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #9b59b6;"></div>
                <span>Position 4</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #00d4ff;"></div>
                <span>Position 5</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #fff; border: 2px solid #888;"></div>
                <span>Root Note</span>
            </div>
        </div>
        
        <div class="exercise-info" id="exerciseInfo">
            Select positions and press Play to start
        </div>
        
        <div class="nav-buttons">
            <button class="nav-btn" id="prevKey">‚Üê Previous Key</button>
            <button class="nav-btn" id="nextKey">Next Key ‚Üí</button>
        </div>
    </div>

    <script>
        const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const noteNamesFlat = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];
        
        // Scale intervals (semitones from root)
        const scales = {
            major: [0, 2, 4, 5, 7, 9, 11], // W W H W W W H
            minor: [0, 2, 3, 5, 7, 8, 10]  // W H W W H W W
        };
        
        // Position colors
        const positionColors = {
            1: '#ff6b6b',
            2: '#ffd93d',
            3: '#6bcb77',
            4: '#9b59b6',
            5: '#00d4ff'
        };
        
        // Open string notes (semitones from C)
        const openStrings = {
            0: 7,  // G
            1: 2,  // D
            2: 9,  // A
            3: 4   // E
        };
        
        // 5 positions for Major scale (2 octaves concept, CAGED-like system for bass)
        // Each position defines fret offsets relative to a starting fret for each string
        // Format: { startFretOffset: number, pattern: [[string, fretOffset, scaleDegreee], ...] }
        
        function generateMajorPositions(rootNote) {
            // Find root on E string
            const rootOnE = (rootNote - openStrings[3] + 12) % 12;
            
            const positions = {
                1: { // Position 1 - starts with index finger on root (E string)
                    startFret: rootOnE,
                    notes: []
                },
                2: { // Position 2
                    startFret: rootOnE + 2,
                    notes: []
                },
                3: { // Position 3
                    startFret: rootOnE + 4,
                    notes: []
                },
                4: { // Position 4
                    startFret: rootOnE + 7,
                    notes: []
                },
                5: { // Position 5
                    startFret: rootOnE + 9,
                    notes: []
                }
            };
            
            // Generate actual notes for each position
            for (let pos = 1; pos <= 5; pos++) {
                const startFret = positions[pos].startFret;
                // Span 4-5 frets per position
                const minFret = startFret;
                const maxFret = startFret + 4;
                
                for (let string = 3; string >= 0; string--) {
                    for (let fret = Math.max(0, minFret - 1); fret <= maxFret + 1; fret++) {
                        const noteValue = (openStrings[string] + fret) % 12;
                        const interval = (noteValue - rootNote + 12) % 12;
                        
                        if (scales.major.includes(interval)) {
                            const isRoot = interval === 0;
                            const scaleDegree = scales.major.indexOf(interval) + 1;
                            
                            // Check if this fret falls within this position's range
                            if (fret >= minFret && fret <= maxFret) {
                                positions[pos].notes.push({
                                    string,
                                    fret,
                                    noteValue,
                                    isRoot,
                                    scaleDegree,
                                    noteName: noteNames[noteValue]
                                });
                            }
                        }
                    }
                }
            }
            
            return positions;
        }
        
        function generateMinorPositions(rootNote) {
            const rootOnE = (rootNote - openStrings[3] + 12) % 12;
            
            const positions = {
                1: { startFret: rootOnE, notes: [] },
                2: { startFret: rootOnE + 2, notes: [] },
                3: { startFret: rootOnE + 5, notes: [] },
                4: { startFret: rootOnE + 7, notes: [] },
                5: { startFret: rootOnE + 10, notes: [] }
            };
            
            for (let pos = 1; pos <= 5; pos++) {
                const startFret = positions[pos].startFret;
                const minFret = startFret;
                const maxFret = startFret + 4;
                
                for (let string = 3; string >= 0; string--) {
                    for (let fret = Math.max(0, minFret - 1); fret <= maxFret + 1; fret++) {
                        const noteValue = (openStrings[string] + fret) % 12;
                        const interval = (noteValue - rootNote + 12) % 12;
                        
                        if (scales.minor.includes(interval)) {
                            const isRoot = interval === 0;
                            const scaleDegree = scales.minor.indexOf(interval) + 1;
                            
                            if (fret >= minFret && fret <= maxFret) {
                                positions[pos].notes.push({
                                    string,
                                    fret,
                                    noteValue,
                                    isRoot,
                                    scaleDegree,
                                    noteName: noteNames[noteValue]
                                });
                            }
                        }
                    }
                }
            }
            
            return positions;
        }
        
        // Audio
        let audioContext;
        let masterGain;
        
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                masterGain = audioContext.createGain();
                masterGain.connect(audioContext.destination);
                masterGain.gain.value = 0.7;
            }
        }

        const stringOpenFrequencies = { 0: 196.00, 1: 146.83, 2: 110.00, 3: 82.41 };

        function playBassNote(string, fret, duration = 0.3) {
            initAudio();
            const now = audioContext.currentTime;
            const freq = stringOpenFrequencies[string] * Math.pow(2, fret / 12);
            
            const osc1 = audioContext.createOscillator();
            const osc2 = audioContext.createOscillator();
            const osc3 = audioContext.createOscillator();
            
            osc1.type = 'sawtooth';
            osc2.type = 'sine';
            osc3.type = 'triangle';
            
            osc1.frequency.value = freq;
            osc2.frequency.value = freq;
            osc3.frequency.value = freq * 2;
            
            const gain1 = audioContext.createGain();
            const gain2 = audioContext.createGain();
            const gain3 = audioContext.createGain();
            
            gain1.gain.value = 0.3;
            gain2.gain.value = 0.5;
            gain3.gain.value = 0.15;
            
            const filter = audioContext.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.value = 800 + (fret * 30);
            
            const envelope = audioContext.createGain();
            envelope.gain.setValueAtTime(0, now);
            envelope.gain.linearRampToValueAtTime(1, now + 0.01);
            envelope.gain.exponentialRampToValueAtTime(0.6, now + 0.08);
            envelope.gain.linearRampToValueAtTime(0.4, now + duration - 0.05);
            envelope.gain.linearRampToValueAtTime(0, now + duration);
            
            osc1.connect(gain1);
            osc2.connect(gain2);
            osc3.connect(gain3);
            gain1.connect(filter);
            gain2.connect(filter);
            gain3.connect(filter);
            filter.connect(envelope);
            envelope.connect(masterGain);
            
            osc1.start(now);
            osc2.start(now);
            osc3.start(now);
            osc1.stop(now + duration);
            osc2.stop(now + duration);
            osc3.stop(now + duration);
        }

        // State
        let currentKey = 0;
        let currentScaleType = 'major';
        let activePositions = new Set([1, 2, 3, 4, 5]);
        let isPlaying = false;
        let currentNoteIndex = 0;
        let intervalId = null;
        let tempo = 70;
        let currentPositions = {};
        
        // DOM
        const keySelect = document.getElementById('keySelect');
        const tempoSlider = document.getElementById('tempoSlider');
        const tempoDisplay = document.getElementById('tempoDisplay');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeDisplay = document.getElementById('volumeDisplay');
        const playBtn = document.getElementById('playBtn');
        const stopBtn = document.getElementById('stopBtn');
        const exerciseInfo = document.getElementById('exerciseInfo');
        const keyDisplay = document.getElementById('keyDisplay');
        const scaleDisplay = document.getElementById('scaleDisplay');
        const fretNumbers = document.getElementById('fretNumbers');
        const allPositionsBtn = document.getElementById('allPositionsBtn');
        const prevKeyBtn = document.getElementById('prevKey');
        const nextKeyBtn = document.getElementById('nextKey');
        
        function initFretboard() {
            for (let fret = 0; fret <= 17; fret++) {
                const numDiv = document.createElement('div');
                numDiv.className = 'fret-num';
                numDiv.textContent = fret;
                fretNumbers.appendChild(numDiv);
            }
            
            const strings = document.querySelectorAll('.string-line');
            strings.forEach((stringLine, stringIndex) => {
                for (let fret = 0; fret <= 17; fret++) {
                    const fretDiv = document.createElement('div');
                    fretDiv.className = 'fret';
                    fretDiv.style.left = `${fret * 45}px`;
                    fretDiv.dataset.string = stringIndex;
                    fretDiv.dataset.fret = fret;
                    
                    const marker = document.createElement('div');
                    marker.className = 'fret-marker';
                    
                    fretDiv.appendChild(marker);
                    stringLine.appendChild(fretDiv);
                    
                    fretDiv.addEventListener('click', () => {
                        playBassNote(stringIndex, fret, 0.4);
                        highlightNote(stringIndex, fret);
                    });
                }
            });
        }
        
        function highlightNote(string, fret) {
            document.querySelectorAll('.fret').forEach(f => f.classList.remove('active'));
            const fretEl = document.querySelector(`.string-line[data-string="${string}"] .fret:nth-child(${fret + 1})`);
            if (fretEl) fretEl.classList.add('active');
        }
        
        function updateDisplay() {
            const rootName = noteNames[currentKey];
            const scaleTypeName = currentScaleType === 'major' ? 'Major' : 'Minor';
            keyDisplay.textContent = `${rootName} ${scaleTypeName}`;
            keyDisplay.style.color = currentScaleType === 'major' ? '#ff6b6b' : '#6bcb77';
            
            const scaleIntervals = scales[currentScaleType];
            const scaleNotes = scaleIntervals.map(interval => noteNames[(currentKey + interval) % 12]);
            scaleDisplay.textContent = scaleNotes.join(' - ');
            
            // Generate positions
            if (currentScaleType === 'major') {
                currentPositions = generateMajorPositions(currentKey);
            } else {
                currentPositions = generateMinorPositions(currentKey);
            }
            
            updateFretboard();
        }
        
        function updateFretboard() {
            // Clear all
            document.querySelectorAll('.fret').forEach(fret => {
                fret.classList.remove('in-scale', 'active', 'root');
                const marker = fret.querySelector('.fret-marker');
                marker.style.background = 'rgba(255, 255, 255, 0.05)';
                marker.style.borderColor = 'transparent';
                marker.style.color = '#555';
                marker.textContent = '';
                marker.classList.remove('multi-color');
            });
            
            // Build a map of fret positions to their positions
            const fretMap = {};
            
            for (let pos = 1; pos <= 5; pos++) {
                if (!activePositions.has(pos)) continue;
                
                currentPositions[pos].notes.forEach(note => {
                    const key = `${note.string}-${note.fret}`;
                    if (!fretMap[key]) {
                        fretMap[key] = {
                            positions: [],
                            note: note
                        };
                    }
                    if (!fretMap[key].positions.includes(pos)) {
                        fretMap[key].positions.push(pos);
                    }
                });
            }
            
            // Apply to fretboard
            Object.entries(fretMap).forEach(([key, data]) => {
                const [string, fret] = key.split('-').map(Number);
                const fretEl = document.querySelector(`.string-line[data-string="${string}"] .fret:nth-child(${fret + 1})`);
                
                if (fretEl) {
                    fretEl.classList.add('in-scale');
                    if (data.note.isRoot) fretEl.classList.add('root');
                    
                    const marker = fretEl.querySelector('.fret-marker');
                    
                    if (data.positions.length === 1) {
                        marker.style.background = positionColors[data.positions[0]];
                        marker.style.borderColor = positionColors[data.positions[0]];
                    } else {
                        // Multi-color for overlapping positions
                        const colors = data.positions.map(p => positionColors[p]);
                        const segments = colors.length;
                        const angle = 360 / segments;
                        let gradient = 'conic-gradient(';
                        colors.forEach((color, i) => {
                            gradient += `${color} ${i * angle}deg ${(i + 1) * angle}deg`;
                            if (i < colors.length - 1) gradient += ', ';
                        });
                        gradient += ')';
                        marker.style.background = gradient;
                        marker.style.borderColor = '#fff';
                    }
                    
                    marker.style.color = '#fff';
                    marker.textContent = data.note.isRoot ? 'R' : data.note.scaleDegree;
                }
            });
        }
        
        function buildExercise() {
            const notes = [];
            
            // Get all active position notes, sorted for playback
            const activeNotes = [];
            
            activePositions.forEach(pos => {
                if (currentPositions[pos]) {
                    currentPositions[pos].notes.forEach(note => {
                        activeNotes.push({ ...note, position: pos });
                    });
                }
            });
            
            // Remove duplicates and sort by string (low to high) then fret
            const uniqueNotes = [];
            const seen = new Set();
            
            activeNotes.forEach(note => {
                const key = `${note.string}-${note.fret}`;
                if (!seen.has(key)) {
                    seen.add(key);
                    uniqueNotes.push(note);
                }
            });
            
            // Sort: E string first, then by fret ascending
            uniqueNotes.sort((a, b) => {
                if (a.string !== b.string) return b.string - a.string; // E(3) first
                return a.fret - b.fret;
            });
            
            // Forward
            notes.push(...uniqueNotes.map(n => ({ ...n, direction: 'forward' })));
            
            // Reverse
            const reversed = [...uniqueNotes].reverse();
            notes.push(...reversed.map(n => ({ ...n, direction: 'reverse' })));
            
            return notes;
        }
        
        function playNoteWithHighlight(note, noteDuration) {
            document.querySelectorAll('.fret').forEach(f => f.classList.remove('active'));
            
            const fretEl = document.querySelector(`.string-line[data-string="${note.string}"] .fret:nth-child(${note.fret + 1})`);
            if (fretEl) fretEl.classList.add('active');
            
            playBassNote(note.string, note.fret, noteDuration);
            
            const stringNames = ['G', 'D', 'A', 'E'];
            const directionText = note.direction === 'forward' ? '‚Üë Ascending' : '‚Üì Descending';
            
            exerciseInfo.innerHTML = `
                <span style="color: ${positionColors[note.position]}; font-weight: bold;">
                    Position ${note.position}
                </span> | 
                Note: <strong>${note.noteName}</strong> |
                String <strong>${stringNames[note.string]}</strong> | 
                Fret <strong>${note.fret}</strong> |
                Degree: <strong>${note.isRoot ? 'Root' : note.scaleDegree}</strong> |
                ${directionText}
            `;
        }
        
        function startPlayback() {
            if (activePositions.size === 0) {
                exerciseInfo.textContent = 'Please select at least one position!';
                return;
            }
            
            initAudio();
            isPlaying = true;
            currentNoteIndex = 0;
            playBtn.disabled = true;
            stopBtn.disabled = false;
            
            const exercise = buildExercise();
            
            if (exercise.length === 0) {
                exerciseInfo.textContent = 'No notes to play!';
                stopPlayback();
                return;
            }
            
            const noteInterval = (60 / tempo) * 1000;
            const noteDuration = noteInterval / 1000 * 0.85;
            
            intervalId = setInterval(() => {
                if (currentNoteIndex >= exercise.length) {
                    currentNoteIndex = 0; // Loop
                }
                
                playNoteWithHighlight(exercise[currentNoteIndex], noteDuration);
                currentNoteIndex++;
            }, noteInterval);
        }
        
        function stopPlayback() {
            isPlaying = false;
            playBtn.disabled = false;
            stopBtn.disabled = true;
            clearInterval(intervalId);
            document.querySelectorAll('.fret').forEach(f => f.classList.remove('active'));
            exerciseInfo.textContent = 'Stopped';
        }
        
        // Event listeners
        keySelect.addEventListener('change', (e) => {
            currentKey = parseInt(e.target.value);
            updateDisplay();
            if (isPlaying) {
                stopPlayback();
                startPlayback();
            }
        });
        
        document.querySelectorAll('.scale-type-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.scale-type-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentScaleType = btn.dataset.type;
                updateDisplay();
                if (isPlaying) {
                    stopPlayback();
                    startPlayback();
                }
            });
        });
        
        document.querySelectorAll('.position-btn[data-position]').forEach(btn => {
            btn.addEventListener('click', () => {
                const pos = parseInt(btn.dataset.position);
                
                if (activePositions.has(pos)) {
                    activePositions.delete(pos);
                    btn.classList.remove('active');
                } else {
                    activePositions.add(pos);
                    btn.classList.add('active');
                }
                
                // Update "All" button state
                allPositionsBtn.classList.toggle('active', activePositions.size === 5);
                
                updateFretboard();
                if (isPlaying) {
                    stopPlayback();
                    startPlayback();
                }
            });
        });
        
        allPositionsBtn.addEventListener('click', () => {
            if (activePositions.size === 5) {
                // Deselect all
                activePositions.clear();
                document.querySelectorAll('.position-btn[data-position]').forEach(b => b.classList.remove('active'));
                allPositionsBtn.classList.remove('active');
            } else {
                // Select all
                activePositions = new Set([1, 2, 3, 4, 5]);
                document.querySelectorAll('.position-btn[data-position]').forEach(b => b.classList.add('active'));
                allPositionsBtn.classList.add('active');
            }
            updateFretboard();
            if (isPlaying) {
                stopPlayback();
                startPlayback();
            }
        });
        
        tempoSlider.addEventListener('input', (e) => {
            tempo = parseInt(e.target.value);
            tempoDisplay.textContent = tempo;
            if (isPlaying) {
                stopPlayback();
                startPlayback();
            }
        });
        
        volumeSlider.addEventListener('input', (e) => {
            const volume = parseInt(e.target.value);
            volumeDisplay.textContent = volume;
            if (masterGain) masterGain.gain.value = volume / 100;
        });
        
        playBtn.addEventListener('click', startPlayback);
        stopBtn.addEventListener('click', stopPlayback);
        
        prevKeyBtn.addEventListener('click', () => {
            currentKey = (currentKey - 1 + 12) % 12;
            keySelect.value = currentKey;
            updateDisplay();
            if (isPlaying) {
                stopPlayback();
                startPlayback();
            }
        });
        
        nextKeyBtn.addEventListener('click', () => {
            currentKey = (currentKey + 1) % 12;
            keySelect.value = currentKey;
            updateDisplay();
            if (isPlaying) {
                stopPlayback();
                startPlayback();
            }
        });
        
        // Initialize
        initFretboard();
        updateDisplay();
    </script>
</body>
</html>