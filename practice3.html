<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bass Scale Exercise - Major & Minor</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
            padding: 20px;
            margin: 0;
            min-height: 100vh;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 10px;
        }
        
        h1 {
            text-align: center;
            color: #00d4ff;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
            margin-bottom: 10px;
        }
        
        .subtitle {
            text-align: center;
            color: #aaa;
            margin-bottom: 20px;
        }
        
        .controls {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .control-group label {
            font-size: 14px;
            color: #aaa;
        }
        
        input[type="range"] {
            width: 150px;
        }
        
        select {
            padding: 8px 12px;
            border-radius: 5px;
            border: none;
            background: #333;
            color: #fff;
            font-size: 14px;
            cursor: pointer;
        }
        
        button {
            background: #00d4ff;
            color: #1a1a2e;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        button:hover {
            background: #00b8e6;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.4);
        }
        
        button:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
        }
        
        .scale-type-selector {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .scale-type-btn {
            padding: 10px 25px;
            font-size: 14px;
            background: rgba(255,255,255,0.1);
            border: 2px solid transparent;
        }
        
        .scale-type-btn.active {
            background: #00d4ff;
            border-color: #00d4ff;
        }
        
        .scale-type-btn.major.active {
            background: #ff6b6b;
            border-color: #ff6b6b;
        }
        
        .scale-type-btn.minor.active {
            background: #6bcb77;
            border-color: #6bcb77;
        }
        
        .positions-container {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .positions-title {
            text-align: center;
            margin-bottom: 10px;
            color: #aaa;
            font-size: 14px;
        }
        
        .positions-grid {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .position-btn {
            padding: 8px 14px;
            font-size: 12px;
            background: rgba(255,255,255,0.1);
            border: 2px solid transparent;
            min-width: 90px;
        }
        
        .position-btn.active {
            border-color: currentColor;
        }
        
        .position-btn.pos1 { color: #ff6b6b; }
        .position-btn.pos1.active { background: rgba(255, 107, 107, 0.3); }
        
        .position-btn.pos2 { color: #ff9f43; }
        .position-btn.pos2.active { background: rgba(255, 159, 67, 0.3); }
        
        .position-btn.pos3 { color: #ffd93d; }
        .position-btn.pos3.active { background: rgba(255, 217, 61, 0.3); }
        
        .position-btn.pos4 { color: #6bcb77; }
        .position-btn.pos4.active { background: rgba(107, 203, 119, 0.3); }
        
        .position-btn.pos5 { color: #00d4ff; }
        .position-btn.pos5.active { background: rgba(0, 212, 255, 0.3); }
        
        .position-btn.pos6 { color: #9b59b6; }
        .position-btn.pos6.active { background: rgba(155, 89, 182, 0.3); }
        
        .position-btn.pos7 { color: #e056fd; }
        .position-btn.pos7.active { background: rgba(224, 86, 253, 0.3); }
        
        .position-btn.all-positions {
            color: #fff;
            background: rgba(255,255,255,0.1);
        }
        
        .position-btn.all-positions.active {
            background: rgba(255,255,255,0.3);
            border-color: #fff;
        }
        
        .current-info {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .key-display {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .scale-display {
            font-size: 14px;
            color: #aaa;
            font-family: monospace;
        }
        
        .fretboard-wrapper {
            overflow-x: auto;
            padding-bottom: 10px;
        }
        
        .fretboard {
            background: linear-gradient(180deg, #3d2b1f 0%, #2a1f15 100%);
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            position: relative;
            min-width: 1100px;
        }
        
        .fret-numbers {
            display: flex;
            margin-left: 40px;
            margin-bottom: 10px;
        }
        
        .fret-num {
            width: 42px;
            text-align: center;
            color: #888;
            font-size: 11px;
        }
        
        .fret-num.has-note {
            color: #00d4ff;
            font-weight: bold;
        }
        
        .string {
            display: flex;
            align-items: center;
            margin: 10px 0;
            position: relative;
        }
        
        .string-label {
            width: 40px;
            font-weight: bold;
            color: #00d4ff;
            font-size: 16px;
        }
        
        .string-line {
            flex: 1;
            height: 4px;
            background: linear-gradient(90deg, #b8860b 0%, #daa520 50%, #b8860b 100%);
            position: relative;
            margin: 0 10px;
            border-radius: 2px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        
        .string[data-string="0"] .string-line { height: 2px; }
        .string[data-string="1"] .string-line { height: 3px; }
        .string[data-string="2"] .string-line { height: 4px; }
        .string[data-string="3"] .string-line { height: 5px; }
        
        .fret {
            position: absolute;
            width: 42px;
            height: 46px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .fret-marker {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #444;
            transition: all 0.15s;
            position: relative;
        }
        
        .fret-marker .fret-number {
            font-size: 14px;
            line-height: 1;
        }
        
        .fret-marker .degree-label {
            font-size: 8px;
            opacity: 0.8;
            margin-top: 1px;
        }
        
        .fret.active .fret-marker {
            transform: scale(1.5);
            box-shadow: 0 0 30px currentColor;
            z-index: 10;
            border-color: #fff !important;
        }
        
        .fret.in-scale .fret-marker {
            color: #fff;
            font-weight: bold;
            border-width: 2px;
        }
        
        .fret.root .fret-marker {
            border-width: 3px;
        }
        
        .fret.root .fret-marker .fret-number {
            font-size: 13px;
        }
        
        .exercise-info {
            text-align: center;
            margin-top: 20px;
            font-size: 16px;
            color: #00d4ff;
            min-height: 30px;
        }
        
        .tempo-display {
            font-size: 24px;
            font-weight: bold;
            color: #00ff88;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: #aaa;
        }
        
        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 50%;
        }
        
        .nav-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }
        
        .nav-btn {
            padding: 8px 20px;
            font-size: 14px;
            background: rgba(255,255,255,0.1);
        }
        
        .nav-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .current-position-display {
            background: rgba(255,255,255,0.1);
            padding: 10px 20px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
            font-size: 18px;
        }
        
        .current-position-display .pos-label {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé∏ Bass Scale Exercise</h1>
        <p class="subtitle">Major & Minor Scales - Full Fretboard Coverage</p>
        
        <div class="controls">
            <div class="control-group">
                <label>Key</label>
                <select id="keySelect">
                    <option value="0">C</option>
                    <option value="1">C# / Db</option>
                    <option value="2">D</option>
                    <option value="3">D# / Eb</option>
                    <option value="4">E</option>
                    <option value="5">F</option>
                    <option value="6">F# / Gb</option>
                    <option value="7">G</option>
                    <option value="8">G# / Ab</option>
                    <option value="9">A</option>
                    <option value="10">A# / Bb</option>
                    <option value="11">B</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Tempo: <span class="tempo-display" id="tempoDisplay">70</span> BPM</label>
                <input type="range" id="tempoSlider" min="40" max="180" value="70" step="5">
            </div>

            <div class="control-group">
                <label>Volume: <span id="volumeDisplay">70</span>%</label>
                <input type="range" id="volumeSlider" min="0" max="100" value="70" step="5">
            </div>
            
            <button id="playBtn">‚ñ∂ Play</button>
            <button id="stopBtn" disabled>‚èπ Stop</button>
        </div>
        
        <div class="scale-type-selector">
            <button class="scale-type-btn major active" data-type="major">Major</button>
            <button class="scale-type-btn minor" data-type="minor">Natural Minor</button>
        </div>
        
        <div class="positions-container">
            <div class="positions-title">Scale Positions (click to toggle)</div>
            <div class="positions-grid" id="positionsGrid">
                <button class="position-btn all-positions active" id="allPositionsBtn">All</button>
            </div>
        </div>
        
        <div class="current-info">
            <div class="key-display" id="keyDisplay">C Major</div>
            <div class="scale-display" id="scaleDisplay">C - D - E - F - G - A - B</div>
        </div>
        
        <div class="fretboard-wrapper">
            <div class="fretboard" id="fretboard">
                <div class="fret-numbers" id="fretNumbers"></div>
                <div class="string" data-string="0">
                    <div class="string-label">G</div>
                    <div class="string-line" data-string="0"></div>
                </div>
                <div class="string" data-string="1">
                    <div class="string-label">D</div>
                    <div class="string-line" data-string="1"></div>
                </div>
                <div class="string" data-string="2">
                    <div class="string-label">A</div>
                    <div class="string-line" data-string="2"></div>
                </div>
                <div class="string" data-string="3">
                    <div class="string-label">E</div>
                    <div class="string-line" data-string="3"></div>
                </div>
            </div>
        </div>
        
        <div class="current-position-display" id="currentPositionDisplay">
            Current: <span class="pos-label" id="currentPosLabel">--</span>
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #ff6b6b;"></div>
                <span>Pos 1</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ff9f43;"></div>
                <span>Pos 2</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ffd93d;"></div>
                <span>Pos 3</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #6bcb77;"></div>
                <span>Pos 4</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #00d4ff;"></div>
                <span>Pos 5</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #9b59b6;"></div>
                <span>Pos 6</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #e056fd;"></div>
                <span>Pos 7</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #fff; border: 2px solid #888;"></div>
                <span>Root (R)</span>
            </div>
        </div>
        
        <div class="exercise-info" id="exerciseInfo">
            Select positions and press Play to start
        </div>
        
        <div class="nav-buttons">
            <button class="nav-btn" id="prevKey">‚Üê Previous Key</button>
            <button class="nav-btn" id="nextKey">Next Key ‚Üí</button>
        </div>
    </div>

    <script>
        const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        
        const scales = {
            major: [0, 2, 4, 5, 7, 9, 11],
            minor: [0, 2, 3, 5, 7, 8, 10]
        };
        
        const positionColors = {
            1: '#ff6b6b',
            2: '#ff9f43',
            3: '#ffd93d',
            4: '#6bcb77',
            5: '#00d4ff',
            6: '#9b59b6',
            7: '#e056fd'
        };
        
        const openStrings = { 0: 7, 1: 2, 2: 9, 3: 4 };
        const MAX_FRET = 24;
        
        function generatePositions(rootNote, scaleType) {
            const scaleIntervals = scales[scaleType];
            const positions = {};
            
            // Find starting frets for positions based on root notes on E string
            const positionStarts = [];
            
            for (let fret = 0; fret <= MAX_FRET - 4; fret++) {
                const noteValue = (openStrings[3] + fret) % 12;
                const interval = (noteValue - rootNote + 12) % 12;
                
                // Start a position on each scale degree
                if (scaleIntervals.includes(interval)) {
                    // Check if too close to existing position
                    let tooClose = positionStarts.some(s => Math.abs(s - fret) < 4);
                    if (!tooClose && positionStarts.length < 7) {
                        positionStarts.push(fret);
                    }
                }
            }
            
            positionStarts.sort((a, b) => a - b);
            
            // Generate notes for each position
            positionStarts.forEach((startFret, index) => {
                const posNum = index + 1;
                const endFret = Math.min(startFret + 4, MAX_FRET);
                
                positions[posNum] = {
                    startFret: startFret,
                    endFret: endFret,
                    notes: []
                };
                
                // Collect notes for this position, organized by string
                for (let string = 3; string >= 0; string--) {
                    const stringNotes = [];
                    
                    for (let fret = startFret; fret <= endFret; fret++) {
                        const noteValue = (openStrings[string] + fret) % 12;
                        const interval = (noteValue - rootNote + 12) % 12;
                        
                        if (scaleIntervals.includes(interval)) {
                            const isRoot = interval === 0;
                            const scaleDegree = scaleIntervals.indexOf(interval) + 1;
                            
                            stringNotes.push({
                                string,
                                fret,
                                noteValue,
                                isRoot,
                                scaleDegree,
                                noteName: noteNames[noteValue]
                            });
                        }
                    }
                    
                    // Sort by fret within string
                    stringNotes.sort((a, b) => a.fret - b.fret);
                    positions[posNum].notes.push(...stringNotes);
                }
            });
            
            return positions;
        }
        
        // Audio
        let audioContext;
        let masterGain;
        
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                masterGain = audioContext.createGain();
                masterGain.connect(audioContext.destination);
                masterGain.gain.value = 0.7;
            }
        }

        const stringOpenFrequencies = { 0: 196.00, 1: 146.83, 2: 110.00, 3: 82.41 };

        function playBassNote(string, fret, duration = 0.3) {
            initAudio();
            const now = audioContext.currentTime;
            const freq = stringOpenFrequencies[string] * Math.pow(2, fret / 12);
            
            const osc1 = audioContext.createOscillator();
            const osc2 = audioContext.createOscillator();
            const osc3 = audioContext.createOscillator();
            
            osc1.type = 'sawtooth';
            osc2.type = 'sine';
            osc3.type = 'triangle';
            
            osc1.frequency.value = freq;
            osc2.frequency.value = freq;
            osc3.frequency.value = freq * 2;
            
            const gain1 = audioContext.createGain();
            const gain2 = audioContext.createGain();
            const gain3 = audioContext.createGain();
            
            gain1.gain.value = 0.3;
            gain2.gain.value = 0.5;
            gain3.gain.value = 0.15;
            
            const filter = audioContext.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.value = 800 + (fret * 30);
            
            const envelope = audioContext.createGain();
            envelope.gain.setValueAtTime(0, now);
            envelope.gain.linearRampToValueAtTime(1, now + 0.01);
            envelope.gain.exponentialRampToValueAtTime(0.6, now + 0.08);
            envelope.gain.linearRampToValueAtTime(0.4, now + duration - 0.05);
            envelope.gain.linearRampToValueAtTime(0, now + duration);
            
            osc1.connect(gain1);
            osc2.connect(gain2);
            osc3.connect(gain3);
            gain1.connect(filter);
            gain2.connect(filter);
            gain3.connect(filter);
            filter.connect(envelope);
            envelope.connect(masterGain);
            
            osc1.start(now);
            osc2.start(now);
            osc3.start(now);
            osc1.stop(now + duration);
            osc2.stop(now + duration);
            osc3.stop(now + duration);
        }

        // State
        let currentKey = 0;
        let currentScaleType = 'major';
        let activePositions = new Set();
        let isPlaying = false;
        let currentNoteIndex = 0;
        let intervalId = null;
        let tempo = 70;
        let currentPositions = {};
        let totalPositions = 0;
        
        // DOM
        const keySelect = document.getElementById('keySelect');
        const tempoSlider = document.getElementById('tempoSlider');
        const tempoDisplay = document.getElementById('tempoDisplay');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeDisplay = document.getElementById('volumeDisplay');
        const playBtn = document.getElementById('playBtn');
        const stopBtn = document.getElementById('stopBtn');
        const exerciseInfo = document.getElementById('exerciseInfo');
        const keyDisplay = document.getElementById('keyDisplay');
        const scaleDisplay = document.getElementById('scaleDisplay');
        const fretNumbers = document.getElementById('fretNumbers');
        const positionsGrid = document.getElementById('positionsGrid');
        const allPositionsBtn = document.getElementById('allPositionsBtn');
        const prevKeyBtn = document.getElementById('prevKey');
        const nextKeyBtn = document.getElementById('nextKey');
        const currentPosLabel = document.getElementById('currentPosLabel');
        
        function initFretboard() {
            for (let fret = 0; fret <= MAX_FRET; fret++) {
                const numDiv = document.createElement('div');
                numDiv.className = 'fret-num';
                numDiv.textContent = fret;
                numDiv.id = `fret-num-${fret}`;
                fretNumbers.appendChild(numDiv);
            }
            
            const strings = document.querySelectorAll('.string-line');
            strings.forEach((stringLine, stringIndex) => {
                for (let fret = 0; fret <= MAX_FRET; fret++) {
                    const fretDiv = document.createElement('div');
                    fretDiv.className = 'fret';
                    fretDiv.style.left = `${fret * 42}px`;
                    fretDiv.dataset.string = stringIndex;
                    fretDiv.dataset.fret = fret;
                    
                    const marker = document.createElement('div');
                    marker.className = 'fret-marker';
                    
                    const fretNumber = document.createElement('span');
                    fretNumber.className = 'fret-number';
                    
                    const degreeLabel = document.createElement('span');
                    degreeLabel.className = 'degree-label';
                    
                    marker.appendChild(fretNumber);
                    marker.appendChild(degreeLabel);
                    fretDiv.appendChild(marker);
                    stringLine.appendChild(fretDiv);
                    
                    fretDiv.addEventListener('click', () => {
                        playBassNote(stringIndex, fret, 0.4);
                        highlightNote(stringIndex, fret);
                    });
                }
            });
        }
        
        function highlightNote(string, fret) {
            document.querySelectorAll('.fret').forEach(f => f.classList.remove('active'));
            const fretEl = document.querySelector(`.string-line[data-string="${string}"] .fret:nth-child(${fret + 1})`);
            if (fretEl) fretEl.classList.add('active');
        }
        
        function updatePositionButtons() {
            const existingBtns = positionsGrid.querySelectorAll('.position-btn[data-position]');
            existingBtns.forEach(btn => btn.remove());
            
            totalPositions = Object.keys(currentPositions).length;
            
            for (let pos = 1; pos <= totalPositions; pos++) {
                const btn = document.createElement('button');
                btn.className = `position-btn pos${pos} active`;
                btn.dataset.position = pos;
                
                const posData = currentPositions[pos];
                btn.textContent = `Pos ${pos} (frets ${posData.startFret}-${posData.endFret})`;
                
                btn.addEventListener('click', () => togglePosition(pos, btn));
                positionsGrid.appendChild(btn);
            }
            
            activePositions = new Set();
            for (let i = 1; i <= totalPositions; i++) {
                activePositions.add(i);
            }
            
            allPositionsBtn.classList.add('active');
        }
        
        function togglePosition(pos, btn) {
            if (activePositions.has(pos)) {
                activePositions.delete(pos);
                btn.classList.remove('active');
            } else {
                activePositions.add(pos);
                btn.classList.add('active');
            }
            
            allPositionsBtn.classList.toggle('active', activePositions.size === totalPositions);
            updateFretboard();
            
            if (isPlaying) {
                stopPlayback();
                startPlayback();
            }
        }
        
        function updateDisplay() {
            const rootName = noteNames[currentKey];
            const scaleTypeName = currentScaleType === 'major' ? 'Major' : 'Minor';
            keyDisplay.textContent = `${rootName} ${scaleTypeName}`;
            keyDisplay.style.color = currentScaleType === 'major' ? '#ff6b6b' : '#6bcb77';
            
            const scaleIntervals = scales[currentScaleType];
            
            let scaleWithFrets = '';
            scaleIntervals.forEach((interval, index) => {
                const noteName = noteNames[(currentKey + interval) % 12];
                const noteValue = (currentKey + interval) % 12;
                
                let fretOnE = -1;
                for (let f = 0; f <= MAX_FRET; f++) {
                    if ((openStrings[3] + f) % 12 === noteValue) {
                        fretOnE = f;
                        break;
                    }
                }
                
                scaleWithFrets += `${noteName}(fret ${fretOnE})`;
                if (index < scaleIntervals.length - 1) scaleWithFrets += ' ‚Üí ';
            });
            
            scaleDisplay.textContent = scaleWithFrets;
            
            currentPositions = generatePositions(currentKey, currentScaleType);
            
            updatePositionButtons();
            updateFretboard();
        }
        
        function updateFretboard() {
            document.querySelectorAll('.fret').forEach(fret => {
                fret.classList.remove('in-scale', 'active', 'root');
                const marker = fret.querySelector('.fret-marker');
                marker.style.background = 'rgba(255, 255, 255, 0.03)';
                marker.style.borderColor = 'transparent';
                marker.style.color = '#444';
                marker.querySelector('.fret-number').textContent = '';
                marker.querySelector('.degree-label').textContent = '';
            });
            
            document.querySelectorAll('.fret-num').forEach(fn => fn.classList.remove('has-note'));
            
            const fretMap = {};
            
            activePositions.forEach(pos => {
                if (!currentPositions[pos]) return;
                
                currentPositions[pos].notes.forEach(note => {
                    const key = `${note.string}-${note.fret}`;
                    if (!fretMap[key]) {
                        fretMap[key] = { positions: [], note: note };
                    }
                    if (!fretMap[key].positions.includes(pos)) {
                        fretMap[key].positions.push(pos);
                    }
                });
            });
            
            const fretsWithNotes = new Set();
            
            Object.entries(fretMap).forEach(([key, data]) => {
                const [string, fret] = key.split('-').map(Number);
                const fretEl = document.querySelector(`.string-line[data-string="${string}"] .fret:nth-child(${fret + 1})`);
                
                fretsWithNotes.add(fret);
                
                if (fretEl) {
                    fretEl.classList.add('in-scale');
                    if (data.note.isRoot) fretEl.classList.add('root');
                    
                    const marker = fretEl.querySelector('.fret-marker');
                    const fretNumberEl = marker.querySelector('.fret-number');
                    const degreeLabelEl = marker.querySelector('.degree-label');
                    
                    if (data.positions.length === 1) {
                        marker.style.background = positionColors[data.positions[0]];
                        marker.style.borderColor = data.note.isRoot ? '#fff' : positionColors[data.positions[0]];
                    } else {
                        const colors = data.positions.map(p => positionColors[p]);
                        const segments = colors.length;
                        const angle = 360 / segments;
                        let gradient = 'conic-gradient(';
                        colors.forEach((color, i) => {
                            gradient += `${color} ${i * angle}deg ${(i + 1) * angle}deg`;
                            if (i < colors.length - 1) gradient += ', ';
                        });
                        gradient += ')';
                        marker.style.background = gradient;
                        marker.style.borderColor = '#fff';
                    }
                    
                    marker.style.color = '#fff';
                    // Big number = fret number
                    fretNumberEl.textContent = fret;
                    // Small label = scale degree or R for root
                    degreeLabelEl.textContent = data.note.isRoot ? 'R' : data.note.scaleDegree;
                }
            });
            
            fretsWithNotes.forEach(fret => {
                const fretNumEl = document.getElementById(`fret-num-${fret}`);
                if (fretNumEl) fretNumEl.classList.add('has-note');
            });
        }
        
        function buildExercise() {
            const exercise = [];
            
            // Get sorted list of active positions
            const sortedPositions = Array.from(activePositions).sort((a, b) => {
                return currentPositions[a].startFret - currentPositions[b].startFret;
            });
            
            // For each position, build ascending then descending sequence
            sortedPositions.forEach(pos => {
                const posData = currentPositions[pos];
                if (!posData || posData.notes.length === 0) return;
                
                // Group notes by string for proper shape traversal
                const notesByString = { 0: [], 1: [], 2: [], 3: [] };
                
                posData.notes.forEach(note => {
                    notesByString[note.string].push({ ...note, position: pos });
                });
                
                // Sort each string's notes by fret
                for (let s = 0; s <= 3; s++) {
                    notesByString[s].sort((a, b) => a.fret - b.fret);
                }
                
                // ASCENDING: E(3) -> A(2) -> D(1) -> G(0), low frets to high frets per string
                const ascending = [];
                for (let string = 3; string >= 0; string--) {
                    ascending.push(...notesByString[string]);
                }
                
                // DESCENDING: G(0) -> D(1) -> A(2) -> E(3), high frets to low frets per string
                const descending = [];
                for (let string = 0; string <= 3; string++) {
                    const reversed = [...notesByString[string]].reverse();
                    descending.push(...reversed);
                }
                
                // Add to exercise with direction markers
                ascending.forEach(note => {
                    exercise.push({ ...note, direction: 'ascending', positionNum: pos });
                });
                
                descending.forEach(note => {
                    exercise.push({ ...note, direction: 'descending', positionNum: pos });
                });
            });
            
            return exercise;
        }
        
        function playNoteWithHighlight(note, noteDuration) {
            document.querySelectorAll('.fret').forEach(f => f.classList.remove('active'));
            
            const fretEl = document.querySelector(`.string-line[data-string="${note.string}"] .fret:nth-child(${note.fret + 1})`);
            if (fretEl) fretEl.classList.add('active');
            
            playBassNote(note.string, note.fret, noteDuration);
            
            const stringNames = ['G', 'D', 'A', 'E'];
            const directionText = note.direction === 'ascending' ? '‚Üë Ascending' : '‚Üì Descending';
            const posColor = positionColors[note.positionNum];
            
            currentPosLabel.innerHTML = `<span style="color: ${posColor}">Position ${note.positionNum}</span> (frets ${currentPositions[note.positionNum].startFret}-${currentPositions[note.positionNum].endFret})`;
            
            exerciseInfo.innerHTML = `
                <span style="color: ${posColor}; font-weight: bold;">
                    Position ${note.positionNum}
                </span> | 
                Note: <strong>${note.noteName}</strong> |
                String <strong>${stringNames[note.string]}</strong> | 
                Fret <strong>${note.fret}</strong> |
                Degree: <strong>${note.isRoot ? 'Root' : note.scaleDegree}</strong> |
                ${directionText}
            `;
        }
        
        function startPlayback() {
            if (activePositions.size === 0) {
                exerciseInfo.textContent = 'Please select at least one position!';
                return;
            }
            
            initAudio();
            isPlaying = true;
            currentNoteIndex = 0;
            playBtn.disabled = true;
            stopBtn.disabled = false;
            
            const exercise = buildExercise();
            
            if (exercise.length === 0) {
                exerciseInfo.textContent = 'No notes to play!';
                stopPlayback();
                return;
            }
            
            const noteInterval = (60 / tempo) * 1000;
            const noteDuration = noteInterval / 1000 * 0.85;
            
            intervalId = setInterval(() => {
                if (currentNoteIndex >= exercise.length) {
                    currentNoteIndex = 0; // Loop
                }
                
                playNoteWithHighlight(exercise[currentNoteIndex], noteDuration);
                currentNoteIndex++;
            }, noteInterval);
        }
        
        function stopPlayback() {
            isPlaying = false;
            playBtn.disabled = false;
            stopBtn.disabled = true;
            clearInterval(intervalId);
            document.querySelectorAll('.fret').forEach(f => f.classList.remove('active'));
            exerciseInfo.textContent = 'Stopped';
            currentPosLabel.textContent = '--';
        }
        
        // Event listeners
        keySelect.addEventListener('change', (e) => {
            currentKey = parseInt(e.target.value);
            updateDisplay();
            if (isPlaying) {
                stopPlayback();
                startPlayback();
            }
        });
        
        document.querySelectorAll('.scale-type-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.scale-type-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentScaleType = btn.dataset.type;
                updateDisplay();
                if (isPlaying) {
                    stopPlayback();
                    startPlayback();
                }
            });
        });
        
        allPositionsBtn.addEventListener('click', () => {
            if (activePositions.size === totalPositions) {
                activePositions.clear();
                document.querySelectorAll('.position-btn[data-position]').forEach(b => b.classList.remove('active'));
                allPositionsBtn.classList.remove('active');
            } else {
                activePositions = new Set();
                for (let i = 1; i <= totalPositions; i++) {
                    activePositions.add(i);
                }
                document.querySelectorAll('.position-btn[data-position]').forEach(b => b.classList.add('active'));
                allPositionsBtn.classList.add('active');
            }
            updateFretboard();
            if (isPlaying) {
                stopPlayback();
                startPlayback();
            }
        });
        
        tempoSlider.addEventListener('input', (e) => {
            tempo = parseInt(e.target.value);
            tempoDisplay.textContent = tempo;
            if (isPlaying) {
                stopPlayback();
                startPlayback();
            }
        });
        
        volumeSlider.addEventListener('input', (e) => {
            const volume = parseInt(e.target.value);
            volumeDisplay.textContent = volume;
            if (masterGain) masterGain.gain.value = volume / 100;
        });
        
        playBtn.addEventListener('click', startPlayback);
        stopBtn.addEventListener('click', stopPlayback);
        
        prevKeyBtn.addEventListener('click', () => {
            currentKey = (currentKey - 1 + 12) % 12;
            keySelect.value = currentKey;
            updateDisplay();
            if (isPlaying) {
                stopPlayback();
                startPlayback();
            }
        });
        
        nextKeyBtn.addEventListener('click', () => {
            currentKey = (currentKey + 1) % 12;
            keySelect.value = currentKey;
            updateDisplay();
            if (isPlaying) {
                stopPlayback();
                startPlayback();
            }
        });
        
        // Initialize
        initFretboard();
        updateDisplay();
    </script>
</body>
</html>
